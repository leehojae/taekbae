<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>배송목록</title>

<!-- Bootstrap -->
<link href="css/bootstrap/bootstrap.css" rel="stylesheet">
<script type="text/javascript" src="js/jquery-1.9.1.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
<script type="text/javascript"
  src="http://api.ktgis.com:10080/v3/olleh/mapAPI.js?key=T2xsZWhNYXBBUEkwMDA0OnZUMVM0TnFWZGk="></script>
<style type="text/css">
header {
	width: 100%;
	background: yellow;
	position: fixed;
	top: 0;
	height: 25px !important;
	z-index: 100;
}
</style>
<script>

	$(function() {
		var id;
		var listLength;

		load_list();

	});

	function load_list() {
		$
				.getJSON(
						'../excel/ajax/deleveryMember.do',
						function(data) {

							var tel = null;
							var records = data.jsonResult.data;
							console.log("records : " + records);
							listLength = records.length;
							id = records[0].id;
							for (var i = 0; i < records.length; i++) {
								tel = records[i].receiverTel1.split("-");
								$('#accordion')
										.append(
												'<div class="panel panel-default">'
														+ '    <div class="panel-heading">'
														+ '       <h4 class="panel-title">'
														+ '         <input type="checkbox" id="'
														+ (i + 1)
														+ '" class="checkGroup" value='
														+ records[i].trcno
														+ '><a data-toggle="collapse" data-parent="#accordion" href="#'+records[i].receiverName+' ">'
														+ records[i].receiverName
														+ '&nbsp'
														+ records[i].receiverAddrRoad
														+ '&nbsp'
														+ records[i].receiverAddrBun
														+ '&nbsp'
														+ records[i].receiverAddrJi
														+ '&nbsp'
														+ records[i].receiverAddrName
														+ '&nbsp'
														+ '<button id="tel"><a href="tel:'+ tel[0] + tel[1] + tel[2] +'">전화걸기</a></button>'
														+ '<button id="sms"><a href="sms:01047311909?body=The SMS message.">문자보내기</a></button>'
														/*                             + '<button id="sms"><a href="sms:'+ tel[0] + tel[1] + tel[2] +'">문자보내기</a></button>' */
														+ '  </a>'
														+ ' 	      </h4>'
														+ ' 	    </div>'
														+ ' 	    <div id="'+records[i].receiverName+'" class="panel-collapse collapse in">'
														+ ' 	      <div class="panel-body">'
														+ '       수취인 :  '
														+ records[i].receiverName
														+ ' <br> '
														+ '      전화번호1 : '
														+ records[i].receiverTel1
														+ ' <br> '
														+ '      전화번호2 : '
														+ records[i].receiverTel2
														+ ' <br> '
														+ '       </div>'
														+ ' 	    </div>'
														+ ' 	  </div>');
							}

							acco();
						});
	};

	function acco() {
		$('.collapse').collapse('hide');
	};

	function init() {

	  var mapOpts;
	  var map;
	  var clusterer;
	  var marker;
	  var addr;
	  var lat;
	  var lng;
	  var pathValue = [];
	  mapOpts = {
	    zoom : 8,
	    center : new olleh.maps.LatLng(37.490086196657664, 127.01953478052013),
	    mapTypeId : 'ROADMAP'
	  };
	  map = new olleh.maps.Map(document.getElementById('map'), mapOpts);

	  clusterer = new olleh.maps.overlay.MarkerClusterer({
	    gap : 100,
	    clusterOpts : {
	      clickToZoom : false,
	      clickToExpand : false
	    }
	  });
	  $.getJSON('../excel/ajax/deleveryMember.do', function(data) {
	    addr = data.jsonResult.data;
	    console.log(addr);
	    for (var i = 0; i < addr.length; i++) {
	      marker = new olleh.maps.overlay.Marker({
	        position : new olleh.maps.LatLng(addr[i].lat, addr[i].lng)
	      });
	        pathValue.push(new olleh.maps.LatLng(addr[i].lat, addr[i].lng));
	      clusterer.add(marker);
	    }
	    clusterer.setMap(map);
	    
	      var path = new olleh.maps.Path(pathValue);
	    	
	    	var polyline = new olleh.maps.vector.Polyline({
	    	 map: map,
	    	 path: path,
	    	 strokeColor: 'blue',
	    	 strokeOpacity: .5,
	    	 strokeWeight: 5
	    	});
	    
	    map.onEvent('click', function (event, payload) {
	      
	      var positions = [];
	      var positionLats = new Array();
	      var positionLngs = new Array();
	      var src = event.getSource();
	      console.log(src.getAllMarkers());
	      var coords = src.getAllMarkers();
	      
	      if(confirm("문자를 전송하시겠습니까?")){
	        for (var i = 0; i < coords.length; i++){
	              positions[i] = new olleh.maps.LatLng.valueOf(coords[i].getPosition()).x;
//	              positions.push({lat: new olleh.maps.LatLng.valueOf(coords[i].getPosition()).y,
//	                lng: new olleh.maps.LatLng.valueOf(coords[i].getPosition()).x});
	        }
	            positions = removeArrayDuplicate(positions);
	            console.log(positions);
	            $.ajaxSettings.traditional = true;
	            $.post('../excel/lngsSmsSend.do', {lngs: positions});
	            function removeArrayDuplicate(array) {
	              var a = {};
	              for (var i = 0; i < array.length; i++) {
	                if (typeof a[array[i]] == "undefined")
	                  a[array[i]] = 1;
	              }
	              array.length = 0;
	              for ( var i in a)
	                array[array.length] = i;
	              return array;
	            }
	          }
	        });
	  }, true);
	}
	
</script>

<style type="text/css">
header {
	width: 100%;
	background: yellow;
	position: fixed;
	top: 0;
	height: 25px !important;
	z-index: 100;
}



</style>

</head>
<body onload="init()">
	<select>
		<option>배송중</option>
		<option>배송완료</option>
		<option>수취인불명</option>
		<option>주소 불확실</option>
	</select>
	<select>
		<option>도로명</option>
		<option>번지명</option>
	</select>
	<input type="button" name="버튼" value="배송처리" onclick="checkDelivery()" />
	<script type="text/javascript">
  
		function checkDelivery() {

			var values = $('input:checkbox:checked.checkGroup').map(function() {
				return this.value;
			}).get();
			$.ajaxSettings.traditional = true;
			$.ajax({
				type: 'POST',
				url: '../excel/stateUpdate.do',
				dataType: "json",
				data: {id: id, count: listLength, updateList: values},
			  success: function(data) {
			     obj = JSON.parse(data);
			     if (obj && obj.success === true) {
			        window.location.href = 'deliveryMember.html';
			     }
			   },
			   error: function(e) {
			     alert('배달완료');
			   }
			});
/*  			$.post('../excel/stateUpdate.do', {id: id, count: listLength, updateList: values}); */
 			location.reload();
 			
		};
	</script>
	<input type="button" name="버튼" value="지도"
		onclick="location.href='map.html'" />
	<div class="panel-group" id="accordion"></div>
	<div id="map" style="width: 100%; height: 768px;"></div>
</body>
</html>